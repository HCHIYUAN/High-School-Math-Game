import React, { useState, useEffect } from 'react';
import { Shield, Sword, RefreshCw, Trophy, Heart, Zap, Target, Divide, Activity, ArrowUpRight, Circle, ChevronRight, User, Users } from 'lucide-react';

// --- éŠæˆ²è³‡æ–™ ---

const CHARACTERS = [
  { 
    id: 'hero_boy', 
    name: 'ç†±è¡€å¹¾ä½•å‹‡è€…', 
    avatar: 'ğŸ¦¸â€â™‚ï¸', 
    color: 'bg-blue-600', 
    borderColor: 'border-blue-400', 
    shadow: 'shadow-blue-500/50',
    desc: 'å……æ»¿æ´»åŠ›çš„ç”·é«˜ä¸­ç”Ÿï¼Œæ“…é•·ç›´è¦ºè§£é¡Œã€‚' 
  },
  { 
    id: 'hero_girl', 
    name: 'æ™ºæ…§ä»£æ•¸å¥³å‚‘', 
    avatar: 'ğŸ¦¸â€â™€ï¸', 
    color: 'bg-rose-500', 
    borderColor: 'border-rose-400', 
    shadow: 'shadow-rose-500/50',
    desc: 'å†·éœæ²ˆè‘—çš„å¥³é«˜ä¸­ç”Ÿï¼Œè¨ˆç®—ç²¾ç¢ºç„¡èª¤ã€‚' 
  },
  { 
    id: 'wizard_boy', 
    name: 'é‚è¼¯æ¨ç†æ³•å¸«', 
    avatar: 'ğŸ§™â€â™‚ï¸', 
    color: 'bg-purple-600', 
    borderColor: 'border-purple-400', 
    shadow: 'shadow-purple-500/50',
    desc: 'æŒæ¡æ•¸å­¸å¥§ç¾©ï¼Œç”¨é­”æ³•èˆ¬çš„å…¬å¼è§£é¡Œã€‚' 
  },
  { 
    id: 'warrior_girl', 
    name: 'å…‰é€Ÿè¨ˆç®—åŠå£«', 
    avatar: 'ğŸ‘©â€ğŸš€', 
    color: 'bg-amber-600', 
    borderColor: 'border-amber-400', 
    shadow: 'shadow-amber-500/50',
    desc: 'åæ‡‰é€Ÿåº¦æ¥µå¿«ï¼Œèƒ½åœ¨ç¬é–“çœ‹ç©¿é¡Œç›®å¼±é»ã€‚' 
  }
];

const TOPICS = [
  {
    id: 'seq',
    name: 'æ•¸åˆ—èˆ‡ç´šæ•¸',
    bossName: 'ç„¡ç›¡åºåˆ—å·¨é­”',
    bossAvatar: 'ğŸ”¢',
    color: 'from-blue-500 to-cyan-400',
    icon: <Divide className="w-6 h-6" />,
    description: 'æŒæ¡è¦å¾‹ï¼Œè¨ˆç®—ç¸½å’Œï¼Œç ´è§£ç„¡çª®çš„è¬é¡Œã€‚',
  },
  {
    id: 'log',
    name: 'æŒ‡æ•¸èˆ‡å°æ•¸',
    bossName: 'æŒ‡æ•¸çˆ†ç‚¸é¾',
    bossAvatar: 'ğŸ“ˆ',
    color: 'from-purple-500 to-pink-400',
    icon: <Activity className="w-6 h-6" />,
    description: 'åœ¨æ¥µå¤§èˆ‡æ¥µå°ä¹‹é–“ï¼Œæ‰¾åˆ°å¹³è¡¡çš„æŒ‡æ•¸ã€‚',
  },
  {
    id: 'vec',
    name: 'å¹³é¢å‘é‡',
    bossName: 'æ–¹å‘å‘é‡é¨å£«',
    bossAvatar: 'â†—ï¸',
    color: 'from-green-500 to-emerald-400',
    icon: <ArrowUpRight className="w-6 h-6" />,
    description: 'æŒæ¡æ–¹å‘èˆ‡é•·åº¦ï¼Œåˆ©ç”¨å…§ç©æ±ºå‹è² ã€‚',
  },
  {
    id: 'geo',
    name: 'ç›´ç·šèˆ‡åœ“',
    bossName: 'å¹¾ä½•åœ“èˆæ›²å¥³çš‡',
    bossAvatar: 'ğŸ¯',
    color: 'from-orange-500 to-red-400',
    icon: <Circle className="w-6 h-6" />,
    description: 'è§£æå¹¾ä½•çš„å¥§ç§˜ï¼Œåˆ‡ç·šèˆ‡è·é›¢æ˜¯é—œéµã€‚',
  },
];

const QUESTION_BANK = {
  seq: [
    { q: 'å·²çŸ¥ç­‰å·®æ•¸åˆ—é¦–é …ç‚º 2ï¼Œå…¬å·®ç‚º 3ï¼Œæ±‚ç¬¬ 10 é …ç‚ºä½•ï¼Ÿ', options: ['27', '29', '32', '35'], correct: 1, explanation: 'an = a1 + (n-1)d â†’ a10 = 2 + 9Ã—3 = 29' },
    { q: 'æ±‚ 1 + 2 + 3 + ... + 100 ä¹‹å’Œï¼Ÿ', options: ['5000', '5050', '5100', '4950'], correct: 1, explanation: 'æ¢¯å½¢å…¬å¼ï¼š(1+100)Ã—100 / 2 = 5050' },
    { q: 'è‹¥ä¸€ç­‰æ¯”æ•¸åˆ—é¦–é …ç‚º 3ï¼Œå…¬æ¯”ç‚º 2ï¼Œå‰‡ç¬¬ 5 é …ç‚ºï¼Ÿ', options: ['24', '48', '96', '12'], correct: 1, explanation: 'an = a1 Ã— r^(n-1) â†’ a5 = 3 Ã— 2^4 = 3 Ã— 16 = 48' },
    { q: 'æ±‚ Î£(k=1 to 10) 5 çš„å€¼ï¼Ÿ', options: ['5', '10', '50', '55'], correct: 2, explanation: 'å¸¸æ•¸é …åŠ ç¸½ï¼š5 Ã— 10 = 50' },
    { q: 'ç„¡çª®ç­‰æ¯”ç´šæ•¸ 1 + 1/2 + 1/4 + 1/8 + ... çš„å’Œç‚ºï¼Ÿ', options: ['1.5', '2', '2.5', 'ç„¡é™å¤§'], correct: 1, explanation: 'å…¬å¼ a1 / (1-r) â†’ 1 / (1-0.5) = 2' },
  ],
  log: [
    { q: 'è¨ˆç®— logâ‚‚8 çš„å€¼ï¼Ÿ', options: ['2', '3', '4', '8'], correct: 1, explanation: '2çš„ä¸‰æ¬¡æ–¹ç­‰æ–¼8ï¼Œæ•…å€¼ç‚º3' },
    { q: 'è‹¥ 10Ë£ = 1000ï¼Œå‰‡ x ç‚ºï¼Ÿ', options: ['2', '3', '10', '100'], correct: 1, explanation: '1000 æ˜¯ 10 çš„ä¸‰æ¬¡æ–¹' },
    { q: 'log 100 + log 10 = ?', options: ['20', '30', '3', '1000'], correct: 2, explanation: 'log 100 = 2, log 10 = 1, ç›¸åŠ ç‚º 3' },
    { q: 'ä¸‹åˆ—ä½•è€…æ­£ç¢ºï¼Ÿ', options: ['log(a+b) = log a + log b', 'log(ab) = log a + log b', 'log(ab) = log a Ã— log b', 'log a / log b = log(a-b)'], correct: 1, explanation: 'å°æ•¸æ€§è³ªï¼šçœŸæ•¸ç›¸ä¹˜ç­‰æ–¼å°æ•¸ç›¸åŠ ' },
    { q: '3â° çš„å€¼ç‚ºï¼Ÿ', options: ['0', '1', '3', 'undefined'], correct: 1, explanation: 'ä»»ä½•éé›¶æ•¸çš„ 0 æ¬¡æ–¹çš†ç‚º 1' },
  ],
  vec: [
    { q: 'è‹¥å‘é‡ a = (3, 4)ï¼Œå‰‡ |a| (é•·åº¦) ç‚ºï¼Ÿ', options: ['5', '7', '12', '25'], correct: 0, explanation: 'âˆš(3Â² + 4Â²) = âˆš25 = 5' },
    { q: 'å‘é‡ a=(1,2) èˆ‡ b=(3,4)ï¼Œæ±‚ a + bï¼Ÿ', options: ['(4,6)', '(2,2)', '(3,8)', '(4,8)'], correct: 0, explanation: 'xåˆ†é‡ç›¸åŠ ï¼Œyåˆ†é‡ç›¸åŠ  â†’ (1+3, 2+4) = (4,6)' },
    { q: 'è‹¥å…©éé›¶å‘é‡å…§ç©ç‚º 0ï¼Œå‰‡å…©å‘é‡çš„é—œä¿‚ç‚ºï¼Ÿ', options: ['å¹³è¡Œ', 'å‚ç›´', 'é‡åˆ', 'ç›¸å'], correct: 1, explanation: 'å…§ç©ç‚º 0 ä»£è¡¨å¤¾è§’ 90 åº¦ï¼Œå³å‚ç›´' },
    { q: 'å‘é‡ a=(2,1), b=(-1,3)ï¼Œæ±‚å…§ç© aÂ·bï¼Ÿ', options: ['1', '5', '-5', '-1'], correct: 0, explanation: 'x1x2 + y1y2 = 2Ã—(-1) + 1Ã—3 = -2 + 3 = 1' },
    { q: 'æŸ¯è¥¿ä¸ç­‰å¼ |a||b| ___ |aÂ·b| ï¼Ÿ', options: ['â‰¥', 'â‰¤', '=', '<'], correct: 0, explanation: 'æŸ¯è¥¿ä¸ç­‰å¼ï¼šé•·åº¦ç©å¤§æ–¼ç­‰æ–¼å…§ç©çš„çµ•å°å€¼' },
  ],
  geo: [
    { q: 'é» (3, 4) åˆ°åŸé»çš„è·é›¢ç‚ºï¼Ÿ', options: ['3', '4', '5', '7'], correct: 2, explanation: 'è·é›¢å…¬å¼ï¼šâˆš(3Â² + 4Â²) = 5' },
    { q: 'åœ“æ–¹ç¨‹å¼ (x-1)Â² + (y+2)Â² = 9 çš„åœ“å¿ƒåº§æ¨™ç‚ºï¼Ÿ', options: ['(1, 2)', '(-1, 2)', '(1, -2)', '(-1, -2)'], correct: 2, explanation: 'æ¨™æº–å¼ (x-h)Â² + (y-k)Â² = rÂ²ï¼Œåœ“å¿ƒç‚º (h,k)' },
    { q: 'æ‰¿ä¸Šé¡Œï¼Œè©²åœ“çš„åŠå¾‘ç‚ºï¼Ÿ', options: ['3', '9', '81', '1'], correct: 0, explanation: 'rÂ² = 9ï¼Œæ•… r = 3' },
    { q: 'ç›´ç·š 3x + 4y - 10 = 0 çš„æ–œç‡ç‚ºï¼Ÿ', options: ['3/4', '-3/4', '4/3', '-4/3'], correct: 1, explanation: 'm = -a/b = -3/4' },
    { q: 'å…©å¹³è¡Œç·š 3x+4y=10 èˆ‡ 3x+4y=20 ä¹‹é–“çš„è·é›¢ï¼Ÿ', options: ['2', '10', '5', '1'], correct: 0, explanation: 'å…¬å¼ |c1-c2| / âˆš(aÂ²+bÂ²) â†’ |10-20| / 5 = 2' },
  ],
};

// --- ä¸»è¦å…ƒä»¶ ---

export default function MathHeroApp() {
  const [gameState, setGameState] = useState('menu'); // menu, charSelect, levelSelect, playing, won, lost
  const [selectedCharacter, setSelectedCharacter] = useState(CHARACTERS[0]); // é è¨­è§’è‰²
  const [selectedTopicId, setSelectedTopicId] = useState(null);
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [playerHp, setPlayerHp] = useState(100);
  const [bossHp, setBossHp] = useState(100);
  const [feedback, setFeedback] = useState(null); 
  const [shake, setShake] = useState(false);
  const [combo, setCombo] = useState(0);

  // åˆå§‹åŒ–é—œå¡
  const startLevel = (topicId) => {
    setSelectedTopicId(topicId);
    setPlayerHp(100);
    setBossHp(100);
    setCombo(0);
    setFeedback(null);
    setGameState('playing');
    loadNewQuestion(topicId);
  };

  const loadNewQuestion = (topicId) => {
    const questions = QUESTION_BANK[topicId];
    const randomIndex = Math.floor(Math.random() * questions.length);
    setCurrentQuestion(questions[randomIndex]);
  };

  const handleAnswer = (optionIndex) => {
    if (feedback) return;

    const isCorrect = optionIndex === currentQuestion.correct;
    
    if (isCorrect) {
      const damage = 20 + (combo * 5); 
      const newBossHp = Math.max(0, bossHp - damage);
      setBossHp(newBossHp);
      setCombo(combo + 1);
      setFeedback({ type: 'correct', selected: optionIndex, msg: `æ­£è§£ï¼é€ æˆ ${damage} é»å‚·å®³ï¼` });

      if (newBossHp === 0) {
        setTimeout(() => setGameState('won'), 1500);
      }
    } else {
      const damage = 25;
      const newPlayerHp = Math.max(0, playerHp - damage);
      setPlayerHp(newPlayerHp);
      setCombo(0);
      setShake(true);
      setFeedback({ type: 'wrong', selected: optionIndex, msg: `éŒ¯èª¤ï¼${currentQuestion.explanation}` });

      if (newPlayerHp === 0) {
        setTimeout(() => setGameState('lost'), 2000);
      } else {
        setTimeout(() => setShake(false), 500);
      }
    }
  };

  const handleNextQuestion = () => {
    setFeedback(null);
    loadNewQuestion(selectedTopicId);
  };

  // --- ç•«é¢æ¸²æŸ“å‡½æ•¸ ---

  const renderMenu = () => (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-slate-900 text-white p-4">
      <div className="text-center mb-12 animate-fade-in-down">
        <h1 className="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500">
          é«˜ä¸­æ•¸å­¸è‹±é›„å‚³
        </h1>
        <p className="text-xl text-gray-300">é«˜ä¸€ä¸‹å­¸æœŸï¼šå››å¤§è©¦ç…‰</p>
      </div>

      <button 
        onClick={() => setGameState('charSelect')}
        className="group relative px-8 py-4 bg-yellow-500 hover:bg-yellow-400 text-slate-900 font-bold text-xl rounded-full transition-all transform hover:scale-105 shadow-[0_0_20px_rgba(234,179,8,0.5)] flex items-center gap-2"
      >
        <Sword className="w-6 h-6" />
        é–‹å§‹å†’éšª
      </button>

      <div className="mt-12 text-sm text-gray-500 text-center max-w-md">
        <p>è€å¸«å¯„èªï¼šé€™ä¸åªæ˜¯éŠæˆ²ï¼Œæ˜¯æª¢é©—ä½ æ•¸åˆ—ã€æŒ‡æ•¸ã€å‘é‡èˆ‡å¹¾ä½•èƒ½åŠ›çš„æˆ°å ´ï¼åŠ æ²¹ï¼</p>
      </div>
    </div>
  );

  // æ–°å¢ï¼šè§’è‰²é¸æ“‡ç•«é¢
  const renderCharSelect = () => (
    <div className="min-h-screen bg-slate-900 text-white p-6 flex flex-col items-center justify-center">
      <h2 className="text-3xl font-bold mb-2 flex items-center gap-2">
        <Users className="w-8 h-8 text-yellow-400" />
        é¸æ“‡ä½ çš„è‹±é›„
      </h2>
      <p className="text-gray-400 mb-8">é¸æ“‡ä¸€ä½ä»£è¡¨ä½ çš„å‹‡è€…é€²å…¥æ•¸å­¸æˆ°å ´</p>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 w-full max-w-5xl">
        {CHARACTERS.map((char) => (
          <button
            key={char.id}
            onClick={() => {
              setSelectedCharacter(char);
              setGameState('levelSelect');
            }}
            className="group relative bg-slate-800 rounded-2xl p-6 border-2 border-slate-700 hover:border-yellow-400 transition-all hover:-translate-y-2 hover:shadow-xl flex flex-col items-center text-center"
          >
            <div className={`w-24 h-24 rounded-full ${char.color} flex items-center justify-center text-6xl shadow-lg mb-4 ring-4 ring-opacity-30 ring-white group-hover:scale-110 transition-transform`}>
              {char.avatar}
            </div>
            <h3 className="text-xl font-bold mb-2 text-white group-hover:text-yellow-400">{char.name}</h3>
            <p className="text-sm text-gray-400">{char.desc}</p>
            
            <div className="absolute bottom-4 opacity-0 group-hover:opacity-100 transition-opacity text-yellow-400 font-bold text-sm flex items-center gap-1">
              é¸æ“‡æ­¤è§’è‰² <ChevronRight size={16} />
            </div>
            <div className="h-6"></div> {/* Spacer for hover text */}
          </button>
        ))}
      </div>
      
      <button 
        onClick={() => setGameState('menu')}
        className="mt-12 text-gray-400 hover:text-white underline"
      >
        è¿”å›ä¸»é¸å–®
      </button>
    </div>
  );

  const renderLevelSelect = () => (
    <div className="min-h-screen bg-slate-900 text-white p-6 flex flex-col items-center">
      <div className="flex items-center gap-4 mb-8 mt-4">
        <div className="flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-full border border-slate-700">
           <span className="text-2xl">{selectedCharacter.avatar}</span>
           <span className="font-bold text-sm text-gray-300">{selectedCharacter.name}</span>
        </div>
        <button onClick={() => setGameState('charSelect')} className="text-xs text-blue-400 hover:underline">æ›´æ›è§’è‰²</button>
      </div>

      <h2 className="text-3xl font-bold mb-6">é¸æ“‡ä½ çš„æˆ°å ´</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
        {TOPICS.map((topic) => (
          <button
            key={topic.id}
            onClick={() => startLevel(topic.id)}
            className={`relative overflow-hidden rounded-2xl p-6 text-left transition-all hover:scale-105 hover:shadow-2xl bg-gradient-to-br ${topic.color} bg-opacity-10 border border-white/10`}
          >
            <div className="absolute top-0 right-0 p-4 opacity-20 text-6xl">
              {topic.bossAvatar}
            </div>
            <div className="relative z-10">
              <div className="flex items-center gap-3 mb-2">
                <div className="p-2 bg-white/20 rounded-lg">
                  {topic.icon}
                </div>
                <h3 className="text-2xl font-bold">{topic.name}</h3>
              </div>
              <p className="text-white/80 mb-4 text-sm min-h-[40px]">{topic.description}</p>
              <div className="flex items-center gap-2 text-xs font-mono bg-black/20 w-fit px-2 py-1 rounded">
                <Target className="w-3 h-3" />
                BOSS: {topic.bossName}
              </div>
            </div>
          </button>
        ))}
      </div>
      <button 
        onClick={() => setGameState('menu')}
        className="mt-8 text-gray-400 hover:text-white underline"
      >
        è¿”å›ä¸»é¸å–®
      </button>
    </div>
  );

  const renderGame = () => {
    const topic = TOPICS.find(t => t.id === selectedTopicId);
    if (!currentQuestion) return <div>Loading...</div>;

    return (
      <div className={`min-h-screen bg-slate-900 text-white flex flex-col ${shake ? 'animate-shake' : ''}`}>
        {/* é ‚éƒ¨ç‹€æ…‹åˆ— */}
        <div className="p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center sticky top-0 z-20 shadow-md">
          <div className="flex items-center gap-2">
            <button onClick={() => setGameState('levelSelect')} className="text-gray-400 hover:text-white">
              &larr; æ’¤é€€
            </button>
            <span className="font-bold text-yellow-400 px-2 py-1 bg-yellow-400/10 rounded hidden md:inline">
              {topic.name}
            </span>
          </div>
          <div className="flex items-center gap-2">
             <span className="text-sm text-gray-400">é€£æ“Š Combo</span>
             <span className={`text-2xl font-black font-mono ${combo > 1 ? 'text-orange-500 scale-110' : 'text-gray-500'} transition-all`}>
               {combo > 0 ? `x${combo}` : '-'}
             </span>
          </div>
        </div>

        <div className="flex-1 max-w-3xl w-full mx-auto p-4 flex flex-col justify-between">
          
          {/* æˆ°å ´å€åŸŸ */}
          <div className="flex justify-between items-center py-4 md:py-8 px-2 md:px-4">
            
            {/* ç©å®¶ç‹€æ…‹ */}
            <div className="text-center relative group">
              <div className={`w-16 h-16 md:w-20 md:h-20 ${selectedCharacter.color} rounded-full flex items-center justify-center text-3xl md:text-4xl shadow-[0_0_20px_rgba(0,0,0,0.5)] ${selectedCharacter.shadow} border-4 ${selectedCharacter.borderColor} mb-2 transition-transform`}>
                {selectedCharacter.avatar}
              </div>
              <div className="w-20 md:w-24 h-4 bg-gray-700 rounded-full overflow-hidden border border-gray-600 relative">
                <div 
                  className="h-full bg-green-500 transition-all duration-500"
                  style={{ width: `${playerHp}%` }}
                ></div>
              </div>
              <p className="text-xs mt-1 font-mono text-gray-300">{selectedCharacter.name}</p>
              
              {/* å—å‚·ç‰¹æ•ˆ */}
              {feedback?.type === 'wrong' && (
                <div className="absolute -top-10 left-0 w-full text-red-500 font-bold animate-bounce text-xl">
                  -25
                </div>
              )}
            </div>

            {/* VS */}
            <div className="text-xl md:text-2xl font-black text-slate-700 italic">VS</div>

            {/* Boss ç‹€æ…‹ */}
            <div className="text-center relative">
              <div className="w-20 h-20 md:w-24 md:h-24 bg-red-900/50 rounded-xl flex items-center justify-center text-5xl md:text-6xl shadow-[0_0_20px_rgba(220,38,38,0.3)] border-2 border-red-500/50 mb-2 animate-pulse-slow">
                {topic.bossAvatar}
              </div>
              <div className="w-24 md:w-28 h-4 bg-gray-700 rounded-full overflow-hidden border border-gray-600">
                <div 
                  className="h-full bg-red-500 transition-all duration-500"
                  style={{ width: `${bossHp}%` }}
                ></div>
              </div>
              <p className="text-xs mt-1 font-mono text-gray-300">{topic.bossName}</p>
              {feedback?.type === 'correct' && (
                <div className="absolute -top-10 left-0 w-full text-yellow-400 font-bold animate-bounce text-xl">
                  HIT!
                </div>
              )}
            </div>
          </div>

          {/* é¡Œç›®èˆ‡å›é¥‹å€åŸŸ */}
          <div className="flex-1 flex flex-col justify-end">
            
            <div className="bg-slate-800 rounded-2xl p-4 md:p-6 shadow-xl mb-4 border border-slate-700">
              <h3 className="text-lg md:text-xl font-medium leading-relaxed mb-6 text-cyan-100 min-h-[3rem]">
                <span className="bg-cyan-900/50 text-cyan-300 text-xs px-2 py-1 rounded mr-2 align-middle">
                  å•é¡Œ
                </span>
                {currentQuestion.q}
              </h3>

              <div className="grid grid-cols-1 gap-3">
                {currentQuestion.options.map((opt, idx) => {
                  let btnClass = "bg-slate-700 hover:bg-slate-600 active:scale-98 hover:shadow-lg";
                  
                  if (feedback) {
                    if (idx === currentQuestion.correct) {
                      btnClass = "bg-green-600 text-white ring-2 ring-green-400 opacity-100";
                    } else if (idx === feedback.selected) {
                      btnClass = "bg-red-600 text-white opacity-50";
                    } else {
                      btnClass = "bg-slate-700 text-gray-500 opacity-30 cursor-not-allowed";
                    }
                  }

                  return (
                    <button
                      key={idx}
                      onClick={() => handleAnswer(idx)}
                      disabled={!!feedback}
                      className={`
                        p-4 text-left rounded-xl transition-all font-medium flex items-center gap-3
                        ${btnClass}
                      `}
                    >
                      <span className="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-xs shrink-0">
                        {String.fromCharCode(65 + idx)}
                      </span>
                      {opt}
                    </button>
                  );
                })}
              </div>
            </div>

            {feedback && (
              <div className="animate-fade-in-up">
                <div className={`
                  p-4 rounded-xl mb-3 flex flex-col gap-2
                  ${feedback.type === 'correct' ? 'bg-green-900/40 border border-green-500/30' : 'bg-red-900/40 border border-red-500/30'}
                `}>
                  <div className={`font-bold text-lg flex items-center gap-2 ${feedback.type === 'correct' ? 'text-green-400' : 'text-red-400'}`}>
                    {feedback.type === 'correct' ? <Zap size={20} /> : <Shield size={20} />}
                    {feedback.type === 'correct' ? 'å›ç­”æ­£ç¢ºï¼' : 'å›ç­”éŒ¯èª¤ï¼'}
                  </div>
                  <div className="text-gray-200 pl-7">
                    {feedback.type === 'wrong' ? feedback.msg.replace('éŒ¯èª¤ï¼', '') : 'ä¹˜å‹è¿½æ“Šï¼Œç¹¼çºŒé€²æ”»ï¼'}
                  </div>
                </div>

                {gameState === 'playing' && (
                  <button 
                    onClick={handleNextQuestion}
                    className="w-full py-4 bg-yellow-500 hover:bg-yellow-400 text-slate-900 font-bold text-xl rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2"
                  >
                    ç¹¼çºŒæˆ°é¬¥ (ä¸‹ä¸€é¡Œ) <ChevronRight />
                  </button>
                )}
              </div>
            )}
            
          </div>

        </div>
      </div>
    );
  };

  const renderWon = () => (
    <div className="min-h-screen bg-green-900 flex flex-col items-center justify-center text-white p-6 text-center animate-fade-in">
      <Trophy className="w-24 h-24 text-yellow-400 mb-6 animate-bounce" />
      <h2 className="text-4xl font-bold mb-2">æŒ‘æˆ°æˆåŠŸï¼</h2>
      <p className="text-xl text-green-200 mb-8">
        {selectedCharacter.name} æ“Šæ•—äº† {TOPICS.find(t => t.id === selectedTopicId)?.bossName}
      </p>
      
      <div className="flex gap-4">
        <button 
          onClick={() => setGameState('levelSelect')}
          className="px-6 py-3 bg-white text-green-900 rounded-full font-bold hover:bg-gray-100 transition-colors"
        >
          æŒ‘æˆ°ä¸‹ä¸€é—œ
        </button>
      </div>
    </div>
  );

  const renderLost = () => (
    <div className="min-h-screen bg-red-950 flex flex-col items-center justify-center text-white p-6 text-center animate-fade-in">
      <Heart className="w-24 h-24 text-red-500 mb-6 animate-pulse" />
      <h2 className="text-4xl font-bold mb-2">æŒ‘æˆ°å¤±æ•—...</h2>
      <p className="text-xl text-red-200 mb-8">{selectedCharacter.name} éœ€è¦é‡æ–°ä¿®ç…‰å†ä¾†æŒ‘æˆ°ï¼</p>
      
      <div className="flex gap-4">
        <button 
          onClick={() => startLevel(selectedTopicId)}
          className="px-6 py-3 bg-red-600 text-white rounded-full font-bold hover:bg-red-500 transition-colors flex items-center gap-2"
        >
          <RefreshCw size={20} />
          å†è©¦ä¸€æ¬¡
        </button>
        <button 
          onClick={() => setGameState('levelSelect')}
          className="px-6 py-3 border border-red-400 text-red-100 rounded-full font-bold hover:bg-red-900 transition-colors"
        >
          æ’¤é€€
        </button>
      </div>
    </div>
  );

  return (
    <div className="font-sans">
      <style>{`
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          75% { transform: translateX(5px); }
        }
        .animate-shake {
          animation: shake 0.4s ease-in-out;
        }
        .animate-pulse-slow {
          animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes fadeInUp {
          from { opacity: 0; transform: translateY(20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
          animation: fadeInUp 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        .animate-fade-in {
          animation: fadeIn 0.5s ease-out forwards;
        }
      `}</style>
      
      {gameState === 'menu' && renderMenu()}
      {gameState === 'charSelect' && renderCharSelect()}
      {gameState === 'levelSelect' && renderLevelSelect()}
      {gameState === 'playing' && renderGame()}
      {gameState === 'won' && renderWon()}
      {gameState === 'lost' && renderLost()}
    </div>
  );
}
